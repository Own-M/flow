<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Founder OS | AI-Powered Execution</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Space Grotesk', 'sans-serif'],
                    },
                    colors: {
                        brand: { 50: '#f0fdf4', 100: '#dcfce7', 500: '#22c55e', 600: '#16a34a', 900: '#14532d' }, 
                        ai: { 50: '#f5f3ff', 100: '#ede9fe', 500: '#8b5cf6', 600: '#7c3aed', 900: '#4c1d95' },
                        dark: { 800: '#1e293b', 900: '#0f172a' }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; -webkit-print-color-adjust: exact; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .custom-checkbox input:checked + div { background-color: #16a34a; border-color: #16a34a; }
        .custom-checkbox input:checked + div svg { display: block; }

        /* Chat Styling */
        .chat-bubble { max-width: 85%; padding: 12px 16px; border-radius: 16px; font-size: 14px; line-height: 1.5; }
        .chat-user { background-color: #1e293b; color: white; border-bottom-right-radius: 4px; align-self: flex-end; margin-left: auto; }
        .chat-ai { background-color: #f3f4f6; color: #1f2937; border-bottom-left-radius: 4px; align-self: flex-start; border: 1px solid #e5e7eb; margin-right: auto; }
        
        /* Markdown Styles in Chat */
        .chat-ai p { margin-bottom: 8px; }
        .chat-ai ul { list-style-type: disc; padding-left: 20px; margin-bottom: 8px; }
        .chat-ai ol { list-style-type: decimal; padding-left: 20px; margin-bottom: 8px; }
        .chat-ai strong { font-weight: 700; color: #4c1d95; }
        .chat-ai h3 { font-weight: 700; font-size: 16px; margin-top: 12px; margin-bottom: 4px; }

        .typing-dot { width: 6px; height: 6px; background-color: #9ca3af; border-radius: 50%; animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="text-slate-800 antialiased h-screen flex flex-col md:flex-row overflow-hidden bg-slate-50 font-sans">

    <!-- Sidebar -->
    <aside class="md:w-20 w-full bg-dark-900 flex md:flex-col flex-row items-center justify-between md:justify-start md:py-6 py-3 px-4 shadow-2xl z-50 no-print flex-shrink-0 order-2 md:order-1 fixed md:relative bottom-0 h-16 md:h-full">
        <div class="md:mb-8 text-brand-500 text-2xl font-bold cursor-pointer hover:scale-110 transition md:block hidden" onclick="window.app.renderDashboard()" title="Dashboard">
            <i class="fa-solid fa-cube"></i>
        </div>
        
        <div id="startup-list" class="flex md:flex-col flex-row gap-3 md:w-full md:px-2 overflow-x-auto md:overflow-y-auto scrollbar-hide items-center md:flex-1 justify-center md:justify-start"></div>

        <div class="flex flex-row md:flex-col gap-3">
             <button onclick="window.app.openSettings()" class="md:mt-auto p-3 text-slate-400 hover:text-white transition" title="Settings / API Key">
                <i class="fa-solid fa-gear"></i>
            </button>
            <button onclick="window.app.openModal('createModal')" class="p-3 bg-brand-600 text-white rounded-xl shadow-lg hover:bg-brand-500 transition transform hover:scale-105 flex flex-col items-center justify-center md:w-12 md:h-12 w-10 h-10" title="Start New Machine">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main id="main-view" class="flex-1 overflow-y-auto relative p-0 w-full order-1 md:order-2 pb-20 md:pb-0">
        <!-- Injected via JS -->
    </main>

    <!-- PDF Generation Container -->
    <div id="pdf-export-container" style="position:fixed; left:-9999px; top:0; width: 210mm; background:white; z-index:-1;"></div>

    <!-- Modal: Create Startup -->
    <div id="createModal" class="fixed inset-0 bg-dark-900/80 hidden z-[100] flex justify-center items-center backdrop-blur-sm no-print p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md animate-fade-in border border-slate-200">
            <h2 class="text-2xl font-bold mb-6 text-slate-900 font-display"><i class="fa-solid fa-bolt text-brand-500 mr-2"></i>Ignite New Machine</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Startup Name</label>
                    <input type="text" id="newStartupName" class="w-full border border-slate-300 rounded-lg p-3 outline-none focus:border-brand-500 focus:ring-1 focus:ring-brand-500 transition" placeholder="e.g. Unicorn AI">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Industry</label>
                    <select id="newStartupIndustry" class="w-full border border-slate-300 rounded-lg p-3 outline-none bg-white">
                        <option>SaaS / Software</option>
                        <option>E-commerce / D2C</option>
                        <option>Agency / Service</option>
                        <option>Fintech</option>
                        <option>HealthTech</option>
                        <option>EdTech</option>
                        <option>Other</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-8">
                <button onclick="window.app.closeModal('createModal')" class="px-5 py-2.5 text-slate-600 hover:bg-slate-100 rounded-lg transition font-medium">Cancel</button>
                <button onclick="window.app.createStartup()" class="px-6 py-2.5 bg-brand-600 text-white font-bold rounded-lg shadow-lg hover:bg-brand-500 hover:shadow-brand-500/30 transition transform hover:-translate-y-0.5">Launch ðŸš€</button>
            </div>
        </div>
    </div>

    <!-- AI Modal -->
    <div id="aiModal" class="fixed inset-0 bg-dark-900/80 hidden z-[100] flex justify-center items-center backdrop-blur-sm no-print p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl h-[600px] animate-fade-in border border-slate-200 flex flex-col overflow-hidden">
            <div class="bg-ai-50 px-6 py-4 border-b border-ai-100 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-ai-600 text-white flex items-center justify-center text-lg shadow-lg">
                        <i class="fa-solid fa-sparkles"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-slate-900 font-display">AI Co-Founder</h2>
                        <p class="text-xs text-ai-600 font-medium">Powered by Gemini 2.5</p>
                    </div>
                </div>
                <button onclick="window.app.closeModal('aiModal')" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div id="chat-history" class="flex-1 overflow-y-auto p-6 space-y-4 bg-white">
                <div class="chat-bubble chat-ai shadow-sm">Hello! I'm your AI Co-Founder. I can help you draft strategies, critique ideas, or just chat.</div>
                <!-- Dynamic Quick Actions will be injected here -->
                <div id="ai-quick-actions" class="grid grid-cols-2 gap-2 mt-4"></div>
            </div>

            <div class="p-4 border-t border-slate-100 bg-slate-50 flex gap-2">
                <input type="text" id="ai-input" class="flex-1 border border-slate-300 rounded-xl px-4 py-3 outline-none focus:border-ai-500" placeholder="Ask AI (e.g., 'Draft my elevator pitch')" onkeypress="if(event.key === 'Enter') window.app.sendAIMessage()">
                <button onclick="window.app.sendAIMessage()" class="bg-ai-600 text-white px-5 rounded-xl hover:bg-ai-700 font-bold transition"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-dark-900/80 hidden z-[100] flex justify-center items-center backdrop-blur-sm no-print p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm animate-fade-in">
            <h3 class="text-lg font-bold mb-4">Settings</h3>
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Gemini API Key</label>
            <input type="password" id="apiKeyInput" class="w-full border border-slate-300 rounded-lg p-2 mb-2 text-sm" placeholder="Paste API Key here">
            <p class="text-xs text-slate-400 mb-4">Get your key from Google AI Studio.</p>
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="window.app.closeModal('settingsModal')" class="px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-lg">Close</button>
                <button onclick="window.app.saveSettings()" class="px-4 py-2 text-sm bg-slate-900 text-white rounded-lg">Save</button>
            </div>
        </div>
    </div>

    <script>
        const apiKey = ""; 

        // --- UTILS for WAV CONVERSION (For TTS) ---
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        function pcmToWav(pcmData, sampleRate = 24000) {
            const numChannels = 1;
            const byteRate = sampleRate * numChannels * 2;
            const blockAlign = numChannels * 2;
            const dataSize = pcmData.length;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            // RIFF chunk
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(view, 8, 'WAVE');

            // fmt sub-chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // PCM
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, 16, true); // Bits per sample

            // data sub-chunk
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true);

            new Uint8Array(buffer, 44).set(pcmData);
            return buffer;
        }

        // Base64 to Uint8Array helper
        function base64ToUint8Array(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes;
        }

        const MASTER_ROADMAP = [
            { stage: "Phase 1: Validation", desc: "Prove the problem exists.", tasks: [
                { id: '1a', text: "Write Problem Statement", done: false },
                { id: '1b', text: "Conduct 10 User Interviews", done: false },
                { id: '1c', text: "Identify 3 Competitors", done: false }
            ]},
            { stage: "Phase 2: MVP Build", desc: "Build minimum viable solution.", tasks: [
                { id: '2a', text: "Design Wireframes", done: false },
                { id: '2b', text: "Develop Core Feature", done: false },
                { id: '2c', text: "Internal Alpha Test", done: false }
            ]},
            { stage: "Phase 3: Launch", desc: "Get first 100 users.", tasks: [
                { id: '3a', text: "Setup Landing Page", done: false },
                { id: '3b', text: "Social Media Launch", done: false },
                { id: '3c', text: "First 10 Paying Customers", done: false }
            ]}
        ];

        class StartupMachine {
            constructor() {
                this.startups = JSON.parse(localStorage.getItem('startup_machine_db_v2')) || [];
                this.userApiKey = localStorage.getItem('gemini_api_key') || '';
                this.activeId = null;
                this.activeView = 'execution'; // execution, founder, strategy, logs
                this.init();
            }

            init() {
                this.renderSidebar();
                this.renderHome();
            }

            save() {
                localStorage.setItem('startup_machine_db_v2', JSON.stringify(this.startups));
                this.renderSidebar();
            }

            // --- NAVIGATION ---
            openSettings() { document.getElementById('apiKeyInput').value = this.userApiKey; this.openModal('settingsModal'); }
            saveSettings() { this.userApiKey = document.getElementById('apiKeyInput').value; localStorage.setItem('gemini_api_key', this.userApiKey); this.closeModal('settingsModal'); }
            openModal(id) { document.getElementById(id).classList.remove('hidden'); }
            closeModal(id) { document.getElementById(id).classList.add('hidden'); }

            // --- CRUD ---
            createStartup() {
                const name = document.getElementById('newStartupName').value;
                const industry = document.getElementById('newStartupIndustry').value;
                if (!name) return alert("Startup Name is required!");

                const newMachine = {
                    id: Date.now().toString(),
                    name: name,
                    industry: industry,
                    logo: null,
                    founded: new Date().toLocaleDateString(),
                    checklist: JSON.parse(JSON.stringify(MASTER_ROADMAP)),
                    finance: { budget: 0, expenses: [] },
                    
                    // --- FOUNDER OS DATA ---
                    founder: {
                        why: "", outcome: "Freedom", vision: "", ambition: "Sustainable Power",
                        runway: { expenses: 0, income: 0, savings: 0, debt: 0 },
                        energy: { sleep: 7, stress: 5, focus: 8 }
                    },
                    opportunity: {
                        scores: { pain: 0, freq: 0, urgency: 0, paying: 0, density: 0, barrier: 0, unfair: 0 },
                        total: 0
                    },
                    validation: {
                        interviews: [], 
                        target: 20
                    },
                    logs: {
                        weekly: [], 
                        experiments: [] 
                    }
                };

                this.startups.push(newMachine);
                this.save();
                this.closeModal('createModal');
                this.openStartup(newMachine.id);
                document.getElementById('newStartupName').value = '';
            }

            deleteStartup(id) {
                if(confirm("Destroy this machine?")) {
                    this.startups = this.startups.filter(s => s.id !== id);
                    this.save();
                    this.renderHome();
                }
            }

            updateLogo(id, input) {
                const file = input.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onloadend = () => { this.getStartup(id).logo = reader.result; this.save(); this.renderStartup(id); };
                    reader.readAsDataURL(file);
                }
            }

            getStartup(id) { return this.startups.find(s => s.id === id); }

            // --- RENDERING ---

            renderSidebar() {
                const list = document.getElementById('startup-list');
                list.innerHTML = '';
                this.startups.forEach(s => {
                    const active = this.activeId === s.id;
                    const div = document.createElement('div');
                    div.className = `w-10 h-10 md:w-12 md:h-12 rounded-xl flex items-center justify-center cursor-pointer transition border-2 flex-shrink-0 ${active ? 'border-brand-500 bg-white shadow-lg' : 'border-slate-700 bg-slate-800 hover:border-slate-500'}`;
                    div.onclick = () => this.openStartup(s.id);
                    div.innerHTML = s.logo 
                        ? `<img src="${s.logo}" class="w-full h-full object-cover rounded-[10px]">` 
                        : `<span class="${active ? 'text-brand-600' : 'text-slate-400'} font-bold font-display text-lg">${s.name.substring(0,2).toUpperCase()}</span>`;
                    list.appendChild(div);
                });
            }

            renderHome() {
                this.activeId = null;
                const main = document.getElementById('main-view');
                if(this.startups.length === 0) {
                    main.innerHTML = `
                        <div class="h-full flex flex-col items-center justify-center p-8 text-center bg-slate-50">
                            <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center text-4xl text-brand-500 shadow-xl mb-6 animate-bounce"><i class="fa-solid fa-power-off"></i></div>
                            <h1 class="text-3xl md:text-5xl font-bold text-slate-900 font-display mb-3">Founder OS</h1>
                            <p class="text-slate-500 text-lg max-w-md mb-8">Build products, not just projects. Validate, Execute, Scale.</p>
                            <button onclick="window.app.openModal('createModal')" class="bg-brand-600 text-white px-8 py-4 rounded-xl shadow-xl hover:-translate-y-1 transition font-bold text-lg">Initialize System</button>
                        </div>`;
                    return;
                }
                
                main.innerHTML = `
                    <div class="p-6 md:p-12 max-w-7xl mx-auto fade-in">
                        <header class="mb-10"><h1 class="text-3xl font-bold text-slate-900 font-display">Command Center</h1></header>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                             <div onclick="window.app.openModal('createModal')" class="bg-white border-2 border-dashed border-slate-300 rounded-2xl p-6 flex flex-col items-center justify-center cursor-pointer hover:border-brand-500 transition min-h-[200px] group">
                                <div class="w-16 h-16 bg-brand-50 text-brand-600 rounded-full flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition"><i class="fa-solid fa-plus"></i></div>
                                <h3 class="font-bold text-slate-700">New Venture</h3>
                            </div>
                            ${this.startups.map(s => {
                                const prog = this.calcProgress(s);
                                return `
                                <div onclick="window.app.openStartup('${s.id}')" class="bg-white rounded-2xl shadow-sm hover:shadow-xl transition border border-slate-200 p-6 cursor-pointer flex flex-col justify-between group relative min-h-[200px]">
                                    <div class="flex items-start justify-between mb-4">
                                        <div class="w-14 h-14 rounded-xl bg-slate-100 flex items-center justify-center overflow-hidden border border-slate-100 shadow-inner">
                                            ${s.logo ? `<img src="${s.logo}" class="w-full h-full object-cover">` : `<span class="font-bold text-slate-400 text-xl font-display">${s.name.substring(0,2).toUpperCase()}</span>`}
                                        </div>
                                        <span class="px-2 py-1 rounded text-[10px] font-bold bg-slate-100 text-slate-500 uppercase">${s.industry}</span>
                                    </div>
                                    <div><h3 class="font-bold text-xl text-slate-800 font-display mb-1 group-hover:text-brand-600 transition">${s.name}</h3></div>
                                    <div class="mt-4">
                                        <div class="w-full bg-slate-100 rounded-full h-2 overflow-hidden"><div class="bg-brand-500 h-2 rounded-full" style="width: ${prog}%"></div></div>
                                        <div class="text-xs text-slate-400 mt-2 text-right">${prog}% Ready</div>
                                    </div>
                                    <button onclick="event.stopPropagation(); window.app.deleteStartup('${s.id}')" class="absolute top-4 right-4 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-trash"></i></button>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>`;
            }

            openStartup(id) {
                this.activeId = id;
                this.renderSidebar();
                this.renderStartup(id);
            }

            switchView(view) {
                this.activeView = view;
                this.renderStartup(this.activeId);
            }

            renderStartup(id) {
                const s = this.getStartup(id);
                const main = document.getElementById('main-view');
                
                // Tabs Configuration
                const tabs = [
                    { id: 'execution', label: 'Execution', icon: 'fa-tasks' },
                    { id: 'founder', label: 'Founder Core', icon: 'fa-heart-pulse' },
                    { id: 'strategy', label: 'Strategy & Valid.', icon: 'fa-chess' },
                    { id: 'logs', label: 'Weekly Rituals', icon: 'fa-book-journal-whills' }
                ];

                main.innerHTML = `
                    <div class="h-full flex flex-col bg-white md:bg-slate-50">
                        <!-- Top Nav -->
                        <div class="bg-white border-b border-slate-200 px-4 md:px-8 py-3 flex flex-col md:flex-row justify-between items-center sticky top-0 z-30 shadow-sm">
                            <div class="flex items-center gap-4 w-full md:w-auto mb-3 md:mb-0">
                                <div class="relative group cursor-pointer w-10 h-10 rounded-lg bg-slate-100 border border-slate-200 flex items-center justify-center overflow-hidden">
                                    ${s.logo ? `<img src="${s.logo}" class="w-full h-full object-cover">` : `<i class="fa-solid fa-camera text-slate-400"></i>`}
                                    <input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="window.app.updateLogo('${s.id}', this)">
                                </div>
                                <div>
                                    <h1 class="text-lg font-bold text-slate-900 font-display leading-tight">${s.name}</h1>
                                </div>
                            </div>
                            
                            <!-- Tab Switcher -->
                            <div class="flex bg-slate-100 p-1 rounded-lg overflow-x-auto max-w-full no-scrollbar">
                                ${tabs.map(t => `
                                    <button onclick="window.app.switchView('${t.id}')" class="px-3 py-1.5 rounded-md text-sm font-medium transition whitespace-nowrap flex items-center gap-2 ${this.activeView === t.id ? 'bg-white text-brand-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}">
                                        <i class="fa-solid ${t.icon}"></i> ${t.label}
                                    </button>
                                `).join('')}
                            </div>

                            <div class="hidden md:flex gap-2 ml-4">
                                <button onclick="window.app.openAI('${s.id}')" class="px-3 py-2 bg-ai-600 text-white rounded-lg text-sm font-bold shadow-lg shadow-ai-500/30 hover:bg-ai-700 transition"><i class="fa-solid fa-sparkles"></i> AI Co-Founder</button>
                                <button onclick="window.app.downloadPDF('${s.id}')" class="px-3 py-2 border border-slate-200 rounded-lg text-slate-600 text-sm hover:bg-slate-50"><i class="fa-solid fa-download"></i></button>
                                <button onclick="window.app.renderHome()" class="px-3 py-2 text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-lg"></i></button>
                            </div>
                        </div>

                        <!-- Content Area -->
                        <div class="flex-1 overflow-y-auto p-4 md:p-8 max-w-6xl mx-auto w-full">
                            ${this.getTabContent(s)}
                        </div>
                    </div>
                `;
            }

            getTabContent(s) {
                switch(this.activeView) {
                    case 'execution': return this.renderExecutionView(s);
                    case 'founder': return this.renderFounderCore(s);
                    case 'strategy': return this.renderStrategyView(s);
                    case 'logs': return this.renderLogsView(s);
                    default: return this.renderExecutionView(s);
                }
            }

            // --- VIEW 1: EXECUTION ---
            renderExecutionView(s) {
                const nextTask = this.getNextTask(s);
                return `
                    <div class="flex flex-col md:flex-row gap-6 fade-in">
                        <div class="w-full md:w-1/3 space-y-6">
                            <div class="bg-gradient-to-br from-brand-600 to-brand-900 rounded-2xl p-6 text-white shadow-xl relative overflow-hidden">
                                <div class="absolute top-0 right-0 p-4 opacity-20 text-6xl"><i class="fa-solid fa-crosshairs"></i></div>
                                <div class="relative z-10">
                                    <div class="text-xs font-bold text-brand-200 uppercase tracking-widest mb-2">Next Priority</div>
                                    <h3 class="text-xl font-bold font-display leading-snug mb-4">${nextTask ? nextTask.text : "All Systems Go!"}</h3>
                                    ${nextTask ? `<button onclick="window.app.scrollToTask('${nextTask.id}')" class="bg-white text-brand-900 px-4 py-2 rounded-lg text-sm font-bold hover:bg-brand-50">Execute <i class="fa-solid fa-arrow-right ml-1"></i></button>` : ''}
                                </div>
                            </div>
                            <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
                                <h4 class="font-bold text-slate-800 mb-4 flex justify-between"><span>Revenue Engine</span> <button onclick="window.app.openFinance('${s.id}')" class="text-xs text-brand-600 hover:underline">Edit</button></h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><div class="text-xs text-slate-400 uppercase font-bold">Budget</div><div class="text-xl font-bold text-slate-900">$${s.finance.budget}</div></div>
                                    <div><div class="text-xs text-slate-400 uppercase font-bold">Burned</div><div class="text-xl font-bold text-red-500">$${this.calcExpenses(s)}</div></div>
                                </div>
                            </div>
                        </div>
                        <div class="w-full md:w-2/3 bg-white rounded-2xl border border-slate-200 p-6">
                            <h2 class="text-xl font-bold text-slate-900 font-display mb-6">Execution Roadmap</h2>
                            <div class="space-y-6">
                                ${s.checklist.map((stage, sIdx) => `
                                    <div class="relative pl-6 border-l-2 border-slate-200 pb-2">
                                        <div class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-white border-2 border-brand-500"></div>
                                        <h3 class="font-bold text-slate-800 mb-2">${stage.stage}</h3>
                                        <div class="space-y-2">
                                            ${stage.tasks.map((t, tIdx) => `
                                                <label id="task-${t.id}" class="flex items-start gap-3 cursor-pointer group custom-checkbox p-2 rounded hover:bg-slate-50">
                                                    <input type="checkbox" class="hidden" onchange="window.app.toggleTask('${s.id}', ${sIdx}, ${tIdx}, this)" ${t.done ? 'checked' : ''}>
                                                    <div class="w-5 h-5 rounded border-2 border-slate-300 flex items-center justify-center bg-white"><svg class="w-3 h-3 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div>
                                                    <span class="text-sm ${t.done ? 'line-through text-slate-400' : 'text-slate-700'}">${t.text}</span>
                                                </label>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            // --- VIEW 2: FOUNDER CORE ---
            renderFounderCore(s) {
                const f = s.founder;
                const monthlyBurn = f.runway.expenses - f.runway.income;
                const runwayMonths = monthlyBurn > 0 ? (f.runway.savings / monthlyBurn).toFixed(1) : "âˆž";
                
                return `
                    <div class="fade-in space-y-6">
                        <div class="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm">
                            <div class="flex justify-between items-start mb-4">
                                <h2 class="text-lg font-bold text-slate-900 font-display"><i class="fa-solid fa-compass text-brand-500 mr-2"></i>Clarity Board</h2>
                                <button onclick="window.app.askAI('Help me refine my startup vision based on my current clarity board')" class="text-xs bg-ai-100 text-ai-700 px-3 py-1.5 rounded-lg hover:bg-ai-200 font-bold transition">âœ¨ Refine Vision</button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase">Why this Startup?</label>
                                    <textarea onchange="window.app.updateFounder('${s.id}', 'why', this.value)" class="w-full border border-slate-200 rounded p-2 text-sm h-20">${f.why}</textarea>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase">Desired Outcome</label>
                                    <select onchange="window.app.updateFounder('${s.id}', 'outcome', this.value)" class="w-full border border-slate-200 rounded p-2 text-sm bg-white">
                                        ${['Freedom', 'Status', 'Impact', 'Money'].map(o => `<option ${f.outcome === o ? 'selected' : ''}>${o}</option>`).join('')}
                                    </select>
                                    <label class="text-xs font-bold text-slate-400 uppercase mt-2 block">5 Year Vision</label>
                                    <input type="text" onchange="window.app.updateFounder('${s.id}', 'vision', this.value)" value="${f.vision}" class="w-full border border-slate-200 rounded p-2 text-sm">
                                </div>
                            </div>
                        </div>
                        <!-- (Runway and Energy code same as before, omitted for brevity but part of the full app) -->
                        <div class="bg-slate-900 text-white rounded-2xl p-6 flex flex-col justify-center items-center shadow-lg">
                            <div class="text-sm font-bold text-slate-400 uppercase mb-2">Survival Time</div>
                            <div class="text-5xl font-bold font-display text-brand-400 mb-1">${runwayMonths}</div>
                            <div class="text-sm text-slate-500">Months based on burn</div>
                        </div>
                    </div>
                `;
            }

            // --- VIEW 3: STRATEGY & VALIDATION ---
            renderStrategyView(s) {
                const opp = s.opportunity;
                const totalScore = Object.values(opp.scores).reduce((a, b) => a + Number(b), 0);
                let verdict = "Kill Idea ðŸ’€";
                let verdictColor = "text-red-500 bg-red-50 border-red-200";
                if(totalScore >= 45) { verdict = "Test It ðŸ§ª"; verdictColor = "text-yellow-600 bg-yellow-50 border-yellow-200"; }
                if(totalScore >= 65) { verdict = "Build It ðŸš€"; verdictColor = "text-brand-600 bg-brand-50 border-brand-200"; }

                const metrics = [
                    { k: 'pain', l: 'Problem Pain' }, { k: 'freq', l: 'Frequency' }, { k: 'urgency', l: 'Urgency' },
                    { k: 'paying', l: 'Paying Behavior' }, { k: 'density', l: 'Competition' }, 
                    { k: 'barrier', l: 'Entry Barrier' }, { k: 'unfair', l: 'Unfair Advantage' }
                ];

                return `
                    <div class="fade-in space-y-6">
                        <!-- Opportunity Filter -->
                        <div class="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-3">
                                <h2 class="text-lg font-bold text-slate-900 font-display"><i class="fa-solid fa-filter text-purple-500 mr-2"></i>Opportunity Filter</h2>
                                <div class="flex gap-2">
                                     <button onclick="window.app.askAI('Generate a 10-slide Pitch Deck Outline for a ${s.industry} startup with ${totalScore}/70 opportunity score. Vision: ${s.founder.vision}. Format as a list of slides.')" class="text-xs bg-slate-900 text-white px-3 py-1.5 rounded-lg hover:bg-slate-700 font-bold transition shadow-md"><i class="fa-solid fa-layer-group mr-1"></i> Pitch Deck</button>
                                     <button onclick="window.app.askAI('Analyze my opportunity score of ${totalScore}/70. The verdict is ${verdict}. Analyze this score.')" class="text-xs bg-ai-100 text-ai-700 px-3 py-1.5 rounded-lg hover:bg-ai-200 font-bold transition">âœ¨ AI Analysis</button>
                                    <div class="px-4 py-1.5 rounded-lg border font-bold ${verdictColor} text-xs md:text-sm whitespace-nowrap">${verdict} (${totalScore}/70)</div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                ${metrics.map(m => `
                                    <div>
                                        <label class="text-xs font-bold text-slate-400 uppercase block mb-1">${m.l}</label>
                                        <select onchange="window.app.updateScore('${s.id}', '${m.k}', this.value)" class="w-full border border-slate-200 rounded p-2 text-sm bg-slate-50">
                                            ${Array.from({length:11}, (_,i) => `<option value="${i}" ${opp.scores[m.k] == i ? 'selected' : ''}>${i}</option>`).join('')}
                                        </select>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Validation Tracker (Code same as before) -->
                        <div class="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-lg font-bold text-slate-900 font-display"><i class="fa-solid fa-clipboard-question text-orange-500 mr-2"></i>Validation Interviews</h2>
                                <button onclick="window.app.addInterview('${s.id}')" class="text-xs bg-slate-900 text-white px-3 py-1.5 rounded">+ Log Interview</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="text-xs text-slate-400 uppercase bg-slate-50">
                                        <tr><th class="p-2">Name/Role</th><th class="p-2">Problem Confirmed?</th><th class="p-2">Price Mentioned?</th><th class="p-2">Action</th></tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100">
                                        ${s.validation.interviews.map((iv, idx) => `
                                            <tr>
                                                <td class="p-2"><input value="${iv.name}" onchange="window.app.updateInterview('${s.id}', ${idx}, 'name', this.value)" class="w-full outline-none bg-transparent"></td>
                                                <td class="p-2"><select onchange="window.app.updateInterview('${s.id}', ${idx}, 'confirmed', this.value)" class="bg-transparent outline-none"><option ${iv.confirmed==='No'?'selected':''}>No</option><option ${iv.confirmed==='Yes'?'selected':''}>Yes</option></select></td>
                                                <td class="p-2"><input value="${iv.price}" onchange="window.app.updateInterview('${s.id}', ${idx}, 'price', this.value)" class="w-20 outline-none bg-transparent"></td>
                                                <td class="p-2"><button onclick="window.app.deleteInterview('${s.id}', ${idx})" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }

            // --- VIEW 4: LOGS & RITUALS ---
            renderLogsView(s) {
                return `
                    <div class="fade-in space-y-6">
                        <div class="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-lg font-bold text-slate-900 font-display"><i class="fa-solid fa-calendar-week text-teal-500 mr-2"></i>Weekly Execution Ritual</h2>
                                <button onclick="window.app.addWeeklyLog('${s.id}')" class="text-xs bg-brand-600 text-white px-3 py-1.5 rounded font-bold">Start New Review</button>
                            </div>
                            <div class="space-y-4">
                                ${s.logs.weekly.map((log, idx) => `
                                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                        <div class="flex justify-between mb-2">
                                            <span class="text-xs font-bold text-slate-400 uppercase">${log.date}</span>
                                            <button onclick="window.app.deleteLog('${s.id}', ${idx})" class="text-red-400"><i class="fa-solid fa-trash"></i></button>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                            <div><span class="font-bold text-brand-600 block">Revenue Driver?</span> <input value="${log.driver}" onchange="window.app.updateLog('${s.id}', ${idx}, 'driver', this.value)" class="w-full bg-transparent border-b border-slate-200 outline-none"></div>
                                            <div><span class="font-bold text-red-500 block">Useless Task?</span> <input value="${log.useless}" onchange="window.app.updateLog('${s.id}', ${idx}, 'useless', this.value)" class="w-full bg-transparent border-b border-slate-200 outline-none"></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            // --- DATA HANDLERS ---
            updateFounder(id, field, val) { const s = this.getStartup(id); s.founder[field] = val; this.save(); }
            updateRunway(id, field, val) { const s = this.getStartup(id); s.founder.runway[field] = Number(val); this.save(); this.renderStartup(id); }
            updateEnergy(id, field, val) { const s = this.getStartup(id); s.founder.energy[field] = Number(val); this.save(); this.renderStartup(id); }
            updateScore(id, key, val) { const s = this.getStartup(id); s.opportunity.scores[key] = Number(val); this.save(); this.renderStartup(id); }
            
            addInterview(id) { const s = this.getStartup(id); s.validation.interviews.push({ name: 'New Interviewee', confirmed: 'No', price: '' }); this.save(); this.renderStartup(id); }
            updateInterview(id, idx, field, val) { const s = this.getStartup(id); s.validation.interviews[idx][field] = val; this.save(); }
            deleteInterview(id, idx) { const s = this.getStartup(id); s.validation.interviews.splice(idx, 1); this.save(); this.renderStartup(id); }

            addWeeklyLog(id) { const s = this.getStartup(id); s.logs.weekly.unshift({ date: new Date().toLocaleDateString(), driver: '', useless: '', automate: '', delegate: '', stop: '' }); this.save(); this.renderStartup(id); }
            updateLog(id, idx, field, val) { const s = this.getStartup(id); s.logs.weekly[idx][field] = val; this.save(); }
            deleteLog(id, idx) { const s = this.getStartup(id); s.logs.weekly.splice(idx, 1); this.save(); this.renderStartup(id); }

            toggleTask(id, sIdx, tIdx, checkbox) {
                const s = this.getStartup(id);
                s.checklist[sIdx].tasks[tIdx].done = checkbox.checked;
                this.save();
                if(checkbox.checked) confetti({ particleCount: 30, spread: 50, origin: { y: 0.7 } });
                document.getElementById(`task-${s.checklist[sIdx].tasks[tIdx].id}`).classList.toggle('opacity-50', checkbox.checked);
            }

            scrollToTask(taskId) { const el = document.getElementById(`task-${taskId}`); if(el) el.scrollIntoView({behavior:'smooth', block:'center'}); }
            getNextTask(s) { for(let st of s.checklist) for(let t of st.tasks) if(!t.done) return t; return null; }
            calcProgress(s) { let total=0, done=0; s.checklist.forEach(st => st.tasks.forEach(t => { total++; if(t.done) done++; })); return total===0 ? 0 : Math.round((done/total)*100); }
            calcExpenses(s) { return s.finance.expenses.reduce((a, b) => a + b.cost, 0); }

            // --- AI LOGIC (UPDATED) ---
            openAI(id) {
                const s = this.getStartup(id);
                document.getElementById('aiModal').classList.remove('hidden');
                
                const actionsContainer = document.getElementById('ai-quick-actions');
                actionsContainer.innerHTML = `
                    <button onclick="window.app.askAI('Analyze my opportunity score of ${Object.values(s.opportunity.scores).reduce((a, b) => a + b, 0)}/70. Is this idea worth pursuing?')" class="p-3 bg-slate-50 border border-slate-200 rounded-xl text-left text-xs font-bold text-slate-600 hover:bg-ai-50 hover:border-ai-200 transition">ðŸ“Š Analyze Opportunity</button>
                    <button onclick="window.app.askAI('Generate a 10-slide Pitch Deck Outline for a ${s.industry} startup.')" class="p-3 bg-slate-50 border border-slate-200 rounded-xl text-left text-xs font-bold text-slate-600 hover:bg-ai-50 hover:border-ai-200 transition">ðŸ“‘ Generate Pitch Deck</button>
                    <button onclick="window.app.askAI('Generate a 3-step marketing plan for my first 100 users.')" class="p-3 bg-slate-50 border border-slate-200 rounded-xl text-left text-xs font-bold text-slate-600 hover:bg-ai-50 hover:border-ai-200 transition">ðŸš€ Growth Plan</button>
                    <button onclick="window.app.askAI('Act as a ruthless VC. Roast my idea based on my clarity board.')" class="p-3 bg-slate-50 border border-slate-200 rounded-xl text-left text-xs font-bold text-slate-600 hover:bg-ai-50 hover:border-ai-200 transition">ðŸ”¥ Roast My Idea</button>
                `;
            }

            askAI(query) {
                document.getElementById('ai-input').value = query;
                this.sendAIMessage();
            }

            async sendAIMessage() {
                const input = document.getElementById('ai-input');
                const message = input.value.trim();
                if (!message) return;

                const history = document.getElementById('chat-history');
                
                history.innerHTML += `<div class="flex w-full mb-4"><div class="chat-bubble chat-user">${message}</div></div>`;
                input.value = '';
                history.scrollTop = history.scrollHeight;

                const loadingId = 'loading-' + Date.now();
                history.innerHTML += `
                    <div class="flex w-full mb-4" id="${loadingId}">
                        <div class="chat-bubble chat-ai flex items-center gap-1">
                            <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                        </div>
                    </div>`;
                history.scrollTop = history.scrollHeight;

                try {
                    const s = this.getStartup(this.activeId);
                    const systemContext = `
                        You are a wise and practical Startup Co-Founder & Advisor.
                        Startup: ${s.name} (${s.industry}).
                        Progress: ${this.calcProgress(s)}%.
                        Vision: ${s.founder.vision} (Goal: ${s.founder.outcome}).
                        
                        Give concise, actionable advice. Use Markdown.
                    `;

                    const response = await this.callGeminiAPI(message, systemContext);
                    
                    document.getElementById(loadingId).remove();

                    // Generate Unique ID for the response to attach Audio listener
                    const msgId = 'msg-' + Date.now();
                    const parsedResponse = marked.parse(response);
                    
                    // Escape single quotes for the onclick handler
                    const safeResponse = response.replace(/'/g, "\\'");

                    history.innerHTML += `
                        <div class="flex w-full mb-4 fade-in items-start gap-2">
                            <div class="chat-bubble chat-ai">
                                ${parsedResponse}
                            </div>
                            <button onclick="window.app.playTTS('${safeResponse}')" class="mt-2 text-ai-600 hover:text-ai-800 bg-ai-50 p-2 rounded-full w-8 h-8 flex items-center justify-center transition" title="Listen">
                                <i class="fa-solid fa-volume-high"></i>
                            </button>
                        </div>`;
                    history.scrollTop = history.scrollHeight;

                } catch (error) {
                    document.getElementById(loadingId).remove();
                    history.innerHTML += `<div class="flex w-full mb-4"><div class="chat-bubble bg-red-100 text-red-800">Error: ${error.message}. Please check your API Key.</div></div>`;
                }
            }

            async callGeminiAPI(userPrompt, systemContext) {
                const key = apiKey || this.userApiKey;
                if (!key) throw new Error("API Key missing");

                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: `System Context: ${systemContext}\n\nUser Question: ${userPrompt}` }]
                        }]
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || "Failed to fetch response");
                }

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            }

            // --- TTS FEATURE ---
            async playTTS(text) {
                const key = apiKey || this.userApiKey;
                if (!key) return alert("API Key missing for TTS");

                try {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${key}`;
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: text.substring(0, 400) }] }], // Limit text for speed/cost
                            generationConfig: {
                                responseModalities: ["AUDIO"],
                                speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } }
                            }
                        })
                    });

                    if (!response.ok) throw new Error("TTS Failed");
                    const data = await response.json();
                    const audioData = data.candidates[0].content.parts[0].inlineData.data;
                    
                    // Decode Base64
                    const binaryString = window.atob(audioData);
                    const len = binaryString.length;
                    const bytes = new Uint8Array(len);
                    for (let i = 0; i < len; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }

                    // Convert PCM to WAV and Play
                    const wavBuffer = pcmToWav(bytes);
                    const blob = new Blob([wavBuffer], { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(blob);
                    const audio = new Audio(audioUrl);
                    audio.play();

                } catch (e) {
                    console.error(e);
                    alert("Error playing audio: " + e.message);
                }
            }

            // PDF Logic (Simplified)
             downloadPDF(id) {
                const s = this.getStartup(id);
                const element = document.getElementById('pdf-export-container');
                element.innerHTML = `<div style="padding:40px; font-family:sans-serif;"><h1>${s.name} Report</h1><p>Generated: ${new Date().toLocaleDateString()}</p></div>`;
                html2pdf().from(element).save(`${s.name}_Report.pdf`);
            }
        }

        window.app = new StartupMachine();
    </script>
</body>
</html>
